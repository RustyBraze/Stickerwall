const ADMIN_TOKEN=localStorage.getItem("auth_token");if(!ADMIN_TOKEN){window.location.href="login.html"}const hostURL=window.location.origin;async function fetchWithAuth(url,options={}){const headers={"Content-Type":"application/json","x-api-key":ADMIN_TOKEN,...options.headers||{}};try{const response=await fetch(url,{...options,headers:headers});if(response.status===403){localStorage.removeItem("auth_token");window.location.href="login.html";return null}return response}catch(error){console.error("Network error:",error);throw error}}async function fetchStickers(){const hostEndpoint=hostURL+"/api/stickers";const response=await fetchWithAuth(hostEndpoint);return await response.json()}async function deleteSticker(uuid){const hostEndpoint=hostURL+`/api/stickers/${uuid}`;await fetchWithAuth(hostEndpoint,{method:"DELETE"});location.reload()}function showStickerModal(sticker){console.log(sticker);console.log("running showStickerModal");const modal=document.getElementById("stickerModal");const modalImage=document.getElementById("modalStickerImage");const modalUsers=document.getElementById("modalUserList");const modalStickerId=document.getElementById("modalStickerId");const modalBtnShowSticker=document.getElementById("modalBtnShowSticker");const modalBtnBanSticker=document.getElementById("modalBtnBanSticker");modalImage.src=sticker.file_path;modalStickerId.value=sticker.sticker_id;modalUsers.innerHTML="";sticker.users.forEach((user=>{const userItem=document.createElement("div");userItem.className="list-group-item";userItem.innerHTML=`\n            <div class="row align-items-center">\n                <div class="col">\n                    <div class="text-body">${user.telegram_user}</div>\n                    <div class="text-muted">${user.telegram_id}</div>\n                </div>\n            </div>\n        `;modalUsers.appendChild(userItem)}));if(sticker.banned){modalBtnShowSticker.classList.add("disabled");modalBtnShowSticker.textContent="Show";modalBtnBanSticker.textContent="Unban";modalBtnBanSticker.onclick=async()=>{await unbanSticker(sticker.sticker_id);await loadStickers();await hideStickerModal()}}else{modalBtnShowSticker.classList.remove("disabled");modalBtnShowSticker.textContent=sticker.visible?"Hide":"Show";modalBtnShowSticker.onclick=async()=>{if(sticker.visible){await hideSticker(sticker.sticker_id)}else{await showSticker(sticker.sticker_id)}await loadStickers();await hideStickerModal()};modalBtnBanSticker.textContent="Ban";modalBtnBanSticker.onclick=async()=>{const reason=prompt("Reason for banning this sticker?");if(reason!==null){await banSticker(sticker.sticker_id,reason);await loadStickers();await hideStickerModal()}}}modal.classList.remove("fade");modal.classList.add("show");modal.style.display="block";modal.removeAttribute("aria-hidden");modal.setAttribute("aria-modal","true");modal.setAttribute("role","dialog")}async function banSticker(stickerUuid,reason=""){const hostEndpoint=hostURL+`/api/stickers/${stickerUuid}`;return await fetchWithAuth(hostEndpoint,{method:"POST",body:JSON.stringify({type:"ban",reason:reason===""?null:reason})})}async function unbanSticker(stickerUuid){const hostEndpoint=hostURL+`/api/stickers/${stickerUuid}`;return await fetchWithAuth(hostEndpoint,{method:"POST",body:JSON.stringify({type:"unban"})})}async function hideSticker(stickerUuid){const hostEndpoint=hostURL+`/api/stickers/${stickerUuid}`;return await fetchWithAuth(hostEndpoint,{method:"POST",body:JSON.stringify({type:"hide"})})}async function showSticker(stickerUuid){const hostEndpoint=hostURL+`/api/stickers/${stickerUuid}`;return await fetchWithAuth(hostEndpoint,{method:"POST",body:JSON.stringify({type:"show"})})}function hideStickerModal(){const modal=document.getElementById("stickerModal");modal.removeAttribute("aria-modal");modal.classList.remove("show");modal.classList.add("fade");modal.style.display="none"}async function loadStickers(){const stickers=await fetchStickers();const activeContainer=document.getElementById("sticker_active");const inactiveContainer=document.getElementById("sticker_inactive");const bannedContainer=document.getElementById("sticker_banned");activeContainer.innerHTML="";inactiveContainer.innerHTML="";bannedContainer.innerHTML="";const stickerGroups={};stickers.forEach((sticker=>{if(!stickerGroups[sticker.sticker_uuid]){stickerGroups[sticker.sticker_uuid]={sticker_id:sticker.sticker_uuid,file_path:sticker.file_path,visible:sticker.visible,banned:sticker.banned,boost_factor:sticker.boost_factor,stats:sticker.stats,users:[]};const usergroup=sticker.telegram;usergroup.forEach((sticker_telegram=>{stickerGroups[sticker.sticker_uuid].users.push({telegram_user:sticker_telegram.user,telegram_id:sticker_telegram.id})}))}}));Object.values(stickerGroups).forEach((stickerGroup=>{let container;if(stickerGroup.banned){container=bannedContainer}else{container=stickerGroup.visible?activeContainer:inactiveContainer}const img=document.createElement("img");img.className="sticker";img.src=stickerGroup.file_path;img.alt="Sticker";img.onclick=()=>showStickerModal(stickerGroup);container.appendChild(img)}))}async function clearAll(){if(confirm("Are you sure you want to clear ALL stickers?")){const stickers=await fetchStickers();for(const id of stickers){await deleteSticker(id)}location.reload()}}function showTab(tab){document.getElementById("stickersTab").style.display=tab==="stickers"?"block":"none";document.getElementById("configTab").style.display=tab==="config"?"block":"none"}document.addEventListener("DOMContentLoaded",(function(){loadStickers();document.querySelectorAll(".btn-close-event").forEach((btn=>{btn.addEventListener("click",hideStickerModal)}));const modal=document.getElementById("stickerModal");modal.addEventListener("click",(function(event){if(event.target===modal){hideStickerModal()}}));document.addEventListener("keydown",(function(event){if(event.key==="Escape"&&modal.classList.contains("show")){hideStickerModal()}}));document.getElementById("deleteStickerBtn").addEventListener("click",(async()=>{const stickerId=document.getElementById("modalStickerId").value;if(confirm("Are you sure you want to delete this sticker?")){await deleteSticker(stickerId);const modal=document.getElementById("stickerModal");modal.removeAttribute("data-show");await loadStickers()}}))}));